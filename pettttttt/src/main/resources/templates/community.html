<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">

<head>
	<meta charset="UTF-8" />
	<title th:text="'Community'">Community</title>
	<!-- CSRF meta tags -->
	<meta name="_csrf" th:content="${_csrf?.token}" />
	<meta name="_csrf_header" th:content="${_csrf?.headerName}" />

	<style>
		/* Container */
		.container {
			max-width: 1100px;
			margin: 40px auto 80px;
			padding: 0 16px;
		}

		/* Create Post Card */
		.create-post-card {
			background: #fff;
			border-radius: 18px;
			box-shadow: 0 4px 24px rgba(0, 0, 0, .12);
			padding: 24px;
			margin-bottom: 32px;
			border: 1.5px solid #e3e7ed;
		}

		/* Post Grid */
		.post-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
			gap: 32px;
			margin-top: 40px;
		}

		/* Card */
		.post-card .card {
			border-radius: 16px;
			overflow: hidden;
			background: #fff;
			box-shadow: 0 4px 24px rgba(0, 0, 0, .12);
		}

		/* Card Image */
		.post-card .card img.card-img-top {
			width: 100%;
			max-height: 320px;
			object-fit: cover;
		}

		/* Card Body */
		.post-card .card-body {
			padding: 16px;
		}

		/* Post Owner */
		.post-card .card-body .d-flex img {
			border-radius: 50%;
			object-fit: cover;
		}

		/* Pet Info */
		.pet-info {
			background: #f8fafc;
			padding: 12px;
			border-radius: 8px;
			margin-bottom: 12px;
		}

		/* Like Button */
		.btn-light.liked {
			color: #ed4956;
		}

		.btn-light i.fas {
			color: #ed4956;
		}

		/* Dropdown Menu for Post Actions */
		.menu-toggle-btn {
			position: absolute;
			top: 15px;
			right: 15px;
			border-radius: 50%;
			padding: 2px 8px;
			background: #fff;
			border: 1px solid #ccc;
			cursor: pointer;
		}

		.dropdown-menu-post-actions {
			position: absolute;
			right: 0;
			top: 100%;
			background: #fff;
			border: 1px solid #ccc;
			border-radius: 8px;
			z-index: 1000;
			display: none;
			min-width: 140px;
			box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
		}

		.dropdown-menu-post-actions .dropdown-item {
			padding: 8px 12px;
			display: block;
			cursor: pointer;
			text-decoration: none;
			color: inherit;
		}

		.dropdown-menu-post-actions .dropdown-item:hover {
			background: #f1f5f9;
		}

		/* Post Image Container */
		.post-image-container {
			position: relative;
			width: 100%;
			max-height: 400px;
			overflow: hidden;
			border-radius: 8px;
			margin-bottom: 16px;
		}

		/* Responsive Post Image */
		.post-image {
			width: 100%;
			height: auto;
			max-height: 400px;
			object-fit: cover;
			display: block;
			border-radius: 8px;
		}

		/* Mobile responsiveness */
		@media (max-width : 768px) {
			.post-image-container {
				max-height: 200px;
				aspect-ratio: 16/9;
			}
		}

		@media (max-width : 480px) {
			.post-image-container {
				max-height: 180px;
			}
		}

		/* Card adjustments for better mobile experience */
		@media (max-width : 768px) {
			.post-grid {
				grid-template-columns: 1fr;
				gap: 20px;
			}

			.container {
				padding: 0 12px;
			}
		}

		/* Fixed aspect ratio approach */
		.post-image-container {
			position: relative;
			width: 100%;
			aspect-ratio: 3/2;
			/* Changed from 4/3 to make it shorter */
			max-height: 250px;
			/* Added maximum height limit */
			overflow: hidden;
			border-radius: 8px;
			margin-bottom: 16px;
		}

		.post-image {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: cover;
			border-radius: 8px;
		}

		/* Post Description */
		.post-description {
			font-size: 1rem;
			line-height: 1.6;
			color: #334155;
			word-wrap: break-word;
			white-space: pre-wrap;
			max-height: 150px;
			overflow-y: auto;
			padding: 12px;
			background: #f8fafc;
			border-radius: 8px;
			border-left: 3px solid #3b82f6;
		}

		/* Scrollbar for description */
		.post-description::-webkit-scrollbar {
			width: 6px;
		}

		.post-description::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 3px;
		}

		.post-description::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}

		@media (max-width : 768px) {
			.post-description {
				font-size: 0.9rem;
				max-height: 120px;
			}

		}

		/* Action Buttons */
		.d-flex.gap-2 button,
		.d-flex.gap-2 a {
			transition: all 0.2s ease;
		}

		.btn-light:hover {
			background-color: #fef2f2;
			border-color: #ed4956;
		}

		.btn-light.liked {
			background-color: #fef2f2;
			border-color: #ed4956;
		}

		@media (max-width: 480px) {
			.d-flex.gap-2 {
				flex-direction: column;
			}

			.flex-fill {
				width: 100%;
			}
		}

		/* Three-dot menu button */
		.btn-light:hover {
			background-color: #f8fafc;
		}

		.dropdown-toggle-no-caret::after {
			display: none;
		}

		/* Ensure card has relative positioning for absolute menu */
		.post-card .card {
			position: relative;
		}
	</style>
</head>

<body>
	<section>
		<div class="container">
			<br>
			<h2 class="text-center mb-4" style="color: #2d3a4b;">Community</h2>

			<!-- Success/Error Messages -->
			<div th:if="${session.succMsg}" class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle me-2"></i> <span th:text="${session.succMsg}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
			<div th:if="${session.errorMsg}" class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="fas fa-exclamation-circle me-2"></i> <span th:text="${session.errorMsg}"></span>
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>

			<!-- Create Post Form -->
			<div class="card position-relative">
				<div th:if="${user != null}" class="create-post-card">
					
					<h5 class="text-center mb-4" style="color: rgb(0, 0, 0);margin-top: 12px;margin-bottom: 12px;">Add Post</h5>
					
					<div style="margin-left: 12px; margin-top: 12px; margin-bottom: 12px; margin-right: 12px;">
						
					<div class="d-flex align-items-center mb-2">
						<img th:src="${user.profileImage}" alt="Your Profile"
							style="width: 60px; height: 60px; margin-right: 10px; border-radius: 50%; object-fit: cover;"
							onerror="this.src='/img/profile_img/default.png'">
						<div>
							<h5 class="mb-0" th:text="${user.name}">User Name</h5>
						</div>
					</div>


					<form th:action="@{/community/create}" method="post" enctype="multipart/form-data">
						<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
							th:value="${_csrf.token}" />

						<div class="row">
							<div class="col-md-6 mb-2">
								<label for="petSelect" class="form-label">Pet:</label> <select
									class="form-select form-select-sm" id="petSelect" name="petId" required>
									<option value="">Choose a pet...</option>
									<option th:each="pet : ${userPets}" th:value="${pet.id}"
										th:text="${pet.name + ' (' + pet.type + ')'}">Pet</option>
								</select>
							</div>

							<div class="col-md-6 mb-2">
								<label for="postImage" class="form-label">Photo:</label> <input type="file"
									class="form-control form-control-sm" id="postImage" name="postImage"
									accept="image/*" onchange="previewImage(event)" required>
							</div>
						</div>

						<div class="mb-2">
							<textarea class="form-control" id="description" name="description" rows="2"
								placeholder="Write something about your pet..." required></textarea>
						</div>

						<img id="imagePreview" class="image-preview" alt="Preview"
							style="display: none; max-width: 200px; max-height: 120px; margin-bottom: 10px; border-radius: 8px; object-fit: cover; border: 1px solid #e3e7ed;">

						<button type="submit" class="btn btn-primary">
							<i class="fas fa-share me-1"></i>Post
						</button>

					</form>
					
				</div>
				</div>
			</div>



			<!-- Prompt to login -->
			<div th:if="${user == null}" class="create-post-card text-center">
				<i class="fas fa-heart"></i>
				<h4 style="color: #2d3a4b; margin-bottom: 16px;">Share Your Pet
					with Community</h4>
				<p style="color: #64748b; margin-bottom: 24px;">Join our
					community to share your pet photos and connect with other pet
					lovers!</p>
				<a href="/signin" class="btn btn-primary"><i class="fas fa-sign-in-alt me-2"></i>Login to Share</a>
			</div>
		</div>

		<!-- Community Posts -->
		<div class="container">
			<div class="post-grid">
				<div class="post-card" th:each="post : ${communityPosts}">
					<div class="card position-relative">

						<div style="margin-left: 12px; margin-top: 12px; margin-bottom: 12px; margin-right: 12px;">
							
							<!-- Dropdown for post actions -->
							<div th:if="${user != null and post.user.id == user.id}"
								class="position-absolute top-0 end-0 m-3">
								<button class="btn btn-sm btn-light dropdown-toggle-no-caret" type="button"
									id="postActionsBtn" data-bs-toggle="dropdown" aria-expanded="false"
									style="border-radius: 50%; width: 36px; height: 36px; padding: 0; border: 1px solid #e5e7eb;">
									<i class="fas fa-ellipsis-v"></i>
								</button>
								<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postActionsBtn">
									<li>
										<form th:action="@{'/community/post/' + ${post.id} + '/delete'}" method="post"
											onsubmit="return confirmDelete()">
											<input type="hidden" th:if="${_csrf != null}"
												th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
											<button type="submit" class="dropdown-item text-danger">
												<i class="fas fa-trash-alt me-2"></i>Delete Post
											</button>
										</form>
									</li>
									<li><a class="dropdown-item text-primary"
											th:href="@{'/community/post/' + ${post.id} + '/edit'}">
											<i class="fas fa-edit me-2"></i>Update Post
										</a></li>
								</ul>
							</div>
							<!-- Post Owner -->


							<div class="d-flex align-items-center mb-3">
								<img th:src="${post.user.profileImage}" alt="User Profile"
									style="width: 50px; height: 50px; margin-right: 12px; border-radius: 50%; object-fit: cover;"
									onerror="this.src='/img/profile_img/default.png'">
								<div>
									<h5 class="mb-0" th:text="${post.user.name}">User Name</h5>
									<small class="text-muted"
										th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">Date</small>
								</div>
							</div>


							<!-- Pet Info -->
							<div class="pet-info d-flex align-items-center"
								style="background: #f8fafc; padding: 12px; border-radius: 8px; margin: 12px 0;">
								<img th:src=" ${post.pet.imagePet}" alt="Pet Image"
									style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px;">
								<div>
									<strong th:text="${post.pet.name}">Pet Name</strong>
									<div class="text-muted small" th:text="${post.pet.type + ' • ' + post.pet.breed}">
										Pet
										Info</div>
									<a class="btn btn-sm btn-outline-primary me-2"
										th:href="@{'/community/pet/' + ${post.pet.id}}">View Pet</a>
								</div>
							</div>

							<!-- Post Description -->
							<p class="card-text post-description mb-3" th:text="${post.description}">Post Description
							</p>


							<!-- Post Image -->
							<img th:if="${post.postImage != null and !post.postImage.empty}"
														th:src="${post.postImage}" alt="Post Image" class="card-img-top">
													<div th:if="${post.postImage == null or post.postImage.empty}"
														class="card-img-top d-flex align-items-center justify-content-center"
														style="height: 220px; color: #94a3b8;">No image</div>

							





							<!-- Like and Comments Actions -->
							<div class="d-flex align-items-center gap-2 mt-3">
								<!-- Like Button -->
								<button type="button" th:id="'like-btn-' + ${post.id}" class="btn btn-light flex-fill"
									th:classappend="${post.likedByCurrentUser} ? ' liked' : ''"
									th:onclick="'toggleLike(' + ${post.id} + ')'" style="border: 1px solid #e5e7eb;">
									<i class="fa-heart" th:classappend="${post.likedByCurrentUser} ? ' fas' : ' far'"
										style="color: #ed4956;"></i> <span th:id="'like-count-' + ${post.id}"
										th:text="${post.likeCount}">0</span>
									Likes
								</button>

								<!-- Comments Button -->
								<a class="btn btn-outline-primary flex-fill"
									th:href="@{'/community/post/' + ${post.id} + '/comments'}">
									<i class="fas fa-comment"></i> Comments
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- No posts -->
			<div th:if="${#lists.isEmpty(communityPosts)}" class="text-center py-5">
				<i class="fas fa-paw fa-3x text-muted mb-3"></i>
				<h4 class="text-muted">No posts yet</h4>
				<p class="text-muted">Be the first to share your pet with the
					community!</p>
			</div>
		</div>

		<script>
			function toggleMenu(button) {
				const menu = button.nextElementSibling;
				document.querySelectorAll('.dropdown-menu-post-actions').forEach(el => {
					if (el !== menu) el.style.display = 'none';
				});
				menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
			}
			document.addEventListener('click', function (event) {
				if (!event.target.closest('.dropdown-menu-post-actions') && !event.target.closest('.menu-toggle-btn')) {
					document.querySelectorAll('.dropdown-menu-post-actions').forEach(el => el.style.display = 'none');
				}
			});

			function confirmDelete() {return confirm("Are you sure you want to delete this post?");}

			function previewImage(event) {
				const input = event.target;
				const preview = document.getElementById('imagePreview');
				if (input.files && input.files[0]) {
					const reader = new FileReader();
					reader.onload = e => {preview.src = e.target.result; preview.style.display = 'block';};
					reader.readAsDataURL(input.files[0]);
				} else {preview.src = ''; preview.style.display = 'none';}
			}

			function getCSRFToken() {const token = document.querySelector('meta[name="_csrf"]'); return token ? token.getAttribute('content') : '';}
			function getCSRFHeader() {const header = document.querySelector('meta[name="_csrf_header"]'); return header ? header.getAttribute('content') : 'X-CSRF-TOKEN';}
			function authHeaders() {
				const headers = {'X-Requested-With': 'XMLHttpRequest'};
				const token = getCSRFToken(), headerName = getCSRFHeader();
				if (token && headerName) headers[headerName] = token;
				return headers;
			}

			async function toggleLike(postId) {
				const btn = document.getElementById('like-btn-' + postId);
				const countEl = document.getElementById('like-count-' + postId);
				const icon = btn.querySelector('i.fa-heart');
				const liked = btn.classList.contains('liked');
				const url = liked ? `/community/post/${postId}/unlike` : `/community/post/${postId}/like`;
				btn.disabled = true;
				try {
					const res = await fetch(url, {method: 'POST', headers: authHeaders(), credentials: 'same-origin'});
					if (res.status === 401 || res.status === 403) {window.location = '/signin'; return;}
					const n = parseInt(await res.text(), 10);
					if (Number.isNaN(n)) throw new Error('Invalid response');
					countEl.textContent = n.toString();
					btn.classList.toggle('liked', !liked);
					icon.classList.remove('far', 'fas');
					icon.classList.add(!liked ? 'fas' : 'far');
				} catch (e) {console.error('toggleLike error', e); alert('Failed to like. Please try again.');}
				finally {btn.disabled = false;}
			}
		</script>
	</section>
</body>

</html>