<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">

<head>
<meta charset="UTF-8" />
<title th:text="'Comments • ' + ${post.user.name}">Comments</title>
<!-- CSRF meta tags -->
<meta name="_csrf" th:content="${_csrf?.token}" />
<meta name="_csrf_header" th:content="${_csrf?.headerName}" />
</head>

<body>
	<section>
		<div class="container"
			style="max-width: 1100px; margin: 90px auto 60px;">
			<div class="row g-4">

				<!-- Left: โพสต์จาก Community -->
				<div class="col-lg-7">
					<div class="card" style="border-radius: 16px; overflow: hidden;">
						<img
							th:src="${post.postImage}"
							alt="Post Image" class="card-img-top"
							style="object-fit: cover; max-height: 420px;">

						<div class="card-body">
							<div class="d-flex align-items-center mb-3">
								<img
									th:src="${user.profileImage}"
									alt="User Profile"
									style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 12px;"onerror="this.src='/img/profile_img/default.png'">
								<div>
									<h5 class="mb-0" th:text="${post.user.name}">User Name</h5>
									<small class="text-muted"
										th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">Date</small>
								</div>
							</div>
							<p class="card-text mb-3" th:text="${post.description}">Post
								Description</p>

							<div
								style="background: #f8fafc; padding: 12px; border-radius: 8px; margin: 12px 0;">
								<div class="d-flex align-items-center">
									<img th:src="${pet.imagePet}"
										alt="Pet Image"
										style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px;">
									<div>
										<strong th:text="${post.pet.name}">Pet Name</strong>
										<div class="text-muted small"
											th:text="${post.pet.type + ' • ' + post.pet.breed}">Pet
											Info</div>
									</div>
								</div>
							</div>

							<!-- Like/Unlike Button for Post -->
<!-- 							<div class="d-flex align-items-center gap-2 mb-3">
								<button type="button" th:id="'like-btn-post-' + ${post.id}"
									class="btn btn-light"
									th:classappend="${likedByCurrentUser} ? ' liked' : ''"
									th:onclick="'togglePostLike(' + ${post.id} + ')'"
									style="border: 1px solid #e5e7eb;"
									th:disabled="${user == null}">
									<i class="fa-heart"
										th:classappend="${likedByCurrentUser} ? ' fas text-danger' : ' far'"></i>
									<span th:id="'like-count-post-' + ${post.id}"
										th:text="${likeCount}">0</span>
								</button>
								<span class="text-muted" th:text="${commentCount} + ' comments'">0
									comments</span>
							</div> -->

							<a href="javascript:history.back()" class="btn btn-outline-secondary">Back to previous page</a>
						</div>
					</div>
				</div>

				<!-- Right: ฟีดคอมเมนต์ -->
				<div class="col-lg-5" id="comments">
					<div class="card" style="border-radius: 16px;">
						<div class="card-body">
							<div
								class="d-flex align-items-center justify-content-between mb-3">
								<h5 class="mb-0">Comments</h5>
								<span class="text-muted" th:text="${commentCount} + ' comments'">0
									comments</span>
							</div>

							<!-- ฟอร์มโพสต์คอมเมนต์ -->
							<div th:if="${user != null}">
								<form
									th:action="@{'/community/post/' + ${post.id} + '/comments'}"
									method="post" class="d-flex gap-2 mb-3">
									<input type="hidden" th:if="${_csrf != null}"
										th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
									<input type="text" name="content" class="form-control"
										placeholder="Write a comment..." required maxlength="1000">
									
									<button class="btn btn-primary d-flex justify-content-center align-items-center" type="submit">
									    Post
									</button>

								</form>
							</div>
							<div th:if="${user == null}" class="alert alert-info py-2">
								Please <a href="/signin">login</a> to comment.
							</div>

							<!-- รายการคอมเมนต์ -->
							<div class="list-group">
								<div class="list-group-item" th:each="c : ${comments}"
									style="padding: 12px;">
									<!-- Comment header with user info -->
									<div class="d-flex align-items-center mb-2">
										<img th:src="${c.user.profileImage}"
											alt="User Profile"
											style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 8px;" onerror="this.src='/img/profile_img/default.png'">
										<strong th:text="${c.user.name}">User</strong> <small
											class="text-muted ms-2"
											th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy HH:mm')}">date</small>
										<span th:if="${c.edited}" class="badge bg-secondary ms-2">edited</span>
									</div>

									<!-- Comment content -->
									<div th:id="'comment-content-' + ${c.id}"
										th:text="${c.content}"
										style="white-space: pre-wrap; margin-bottom: 8px; padding-right: 20px;"></div>

									<!-- Action buttons (moved to bottom) -->
									<div th:if="${user != null}"
										class="d-flex justify-content-end gap-2"
										style="margin-top: 8px;">
										<!-- Edit button (only for comment owner) -->
										<button th:if="${user.id == c.user.id}" type="button"
											class="btn btn-sm btn-outline-primary"
											th:onclick="'editComment(' + ${c.id} + ')'">
											<i class="fas fa-edit"></i> Edit
										</button>

										<!-- Delete button (for comment owner or post owner) -->
										<form th:if="${user.id == c.user.id}"
											th:action="@{'/community/comment/' + ${c.id} + '/delete'}"
											method="post"
											onsubmit="return confirm('Are you sure you want to delete this comment?');"
											style="display: inline; margin: 0;">
											<input type="hidden" th:if="${_csrf != null}"
												th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
											<button type="submit" class="btn btn-sm btn-outline-danger">
												<i class="fas fa-trash"></i> Delete
											</button>
										</form>
									</div>
								</div>
								<div th:if="${#lists.isEmpty(comments)}"
									class="text-muted text-center py-3">No comments yet. Be
									the first to comment!</div>
							</div>
						</div>
					</div>
				</div>


			</div>
		</div>

		<!-- Edit Comment Modal -->
		<div class="modal fade" id="editCommentModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Comment</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<textarea id="editCommentText" class="form-control" rows="4"
							maxlength="1000"></textarea>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary"
							onclick="saveCommentEdit()">Save Changes</button>
					</div>
				</div>
			</div>
		</div>

		<!-- JavaScript -->
		<script>
			let currentEditingCommentId = null;

			function getCSRFToken() {
				const token = document.querySelector('meta[name="_csrf"]');
				return token ? token.getAttribute('content') : '';
			}

			function getCSRFHeader() {
				const header = document
						.querySelector('meta[name="_csrf_header"]');
				return header ? header.getAttribute('content') : 'X-CSRF-TOKEN';
			}

			function authHeaders() {
				const headers = {
					'X-Requested-With' : 'XMLHttpRequest'
				};
				const token = getCSRFToken();
				const headerName = getCSRFHeader();

				if (token && headerName) {
					headers[headerName] = token;
				}

				return headers;
			}

			// Toggle like for post
			async
			function togglePostLike(postId) {
				const btn = document.getElementById('like-btn-post-' + postId);
				const cnt = document
						.getElementById('like-count-post-' + postId);
				const icon = btn.querySelector('i.fa-heart');
				const liked = btn.classList.contains('liked');
				const url = liked ? `/community/post/${postId}/unlike`
						: `/community/post/${postId}/like`;

				btn.disabled = true;
				try {
					const res = await
					fetch(url, {
						method : 'POST',
						headers : authHeaders(),
						credentials : 'same-origin'
					});

					if (res.status === 401 || res.status === 403) {
						location.href = '/signin';
						return;
					}

					const text = await
					res.text();
					const n = parseInt(text, 10);
					if (!Number.isNaN(n)) {
						cnt.textContent = n.toString();
						btn.classList.toggle('liked', !liked);
						icon.classList.remove('far', 'fas', 'text-danger');
						if (!liked) {
							icon.classList.add('fas', 'text-danger');
						} else {
							icon.classList.add('far');
						}
					}
				} catch (e) {
					console.error('togglePostLike error', e);
				} finally {
					btn.disabled = false;
				}
			}

			// Edit comment functions
			async function editComment(commentId) {
				currentEditingCommentId = commentId;

				try {
					const res = await
					fetch(`/community/comment/${commentId}/edit`, {
						method : 'GET',
						headers : authHeaders(),
						credentials : 'same-origin'
					});

					const data = await
					res.json();
					if (data.success) {
						document.getElementById('editCommentText').value = data.content;
						new bootstrap.Modal(document
								.getElementById('editCommentModal')).show();
					} else {
						alert(data.message
								|| 'Failed to load comment for editing');
					}
				} catch (e) {
					console.error('editComment error', e);
					alert('Failed to load comment for editing');
				}
			}

			async function saveCommentEdit() {
				if (!currentEditingCommentId)
					return;

				const content = document.getElementById('editCommentText').value
						.trim();
				if (!content) {
					alert('Comment content cannot be empty');
					return;
				}

				try {
					const formData = new FormData();
					formData.append('content', content);

					const res = await
					fetch(`/community/comment/${currentEditingCommentId}/edit`,
							{
								method : 'POST',
								headers : authHeaders(),
								body : formData,
								credentials : 'same-origin'
							});

					const data = await
					res.json();
					if (data.success) {
						// Update the comment content in the DOM
						document.getElementById('comment-content-'
								+ currentEditingCommentId).textContent = data.content;
						bootstrap.Modal.getInstance(
								document.getElementById('editCommentModal'))
								.hide();

						// Show success message or reload page
						location.reload();
					} else {
						alert(data.message || 'Failed to update comment');
					}
				} catch (e) {
					console.error('saveCommentEdit error', e);
					alert('Failed to update comment');
				}
			}
		</script>

	</section>
</body>

</html>
