<!--edit_pet.html-->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">

<head>
	<meta charset="UTF-8">
	<title>Edit Pet</title>
</head>

<body>
	<section>
		<div class="container profile-card"> <!-- ✅ Form to edit an existing pet -->
			<div class="card mt-4 p-3">
				<h3>Edit Pet</h3>
				<form th:action="@{'/admin/pet/edit/' + ${pet.id}}" method="post" enctype="multipart/form-data">
					<div class="row mb-2">
						<div class="col"> <label for="name" class="form-label">Pet Name</label> <input type="text"
								class="form-control" id="name" name="name" th:value="${pet.name}" required> </div>
						<div class="col"> <label for="type" class="form-label">Pet Type</label> <input type="text"
								class="form-control" id="type" name="type" th:value="${pet.type}" required> </div>
					</div>
					<div class="row mb-2 autocomplete">
						<div class="col">
							<label for="ownerEmail" class="form-label">Change Owner From Email</label>
							<input type="text" class="form-control" id="ownerEmail" placeholder="Type email..."
								th:value="${pet.owner.email}" required>
							<!-- hidden field เก็บค่า id ของเจ้าของคนปัจจุบัน -->
							<input type="hidden" id="ownerId" name="owner.id" th:value="${pet.owner.id}">
						</div>
					</div>
					<div class="row mb-2">
						<div class="col">
							<label for="breed" class="form-label">Breed</label>
							<input type="text" class="form-control" id="breed" name="breed" th:value="${pet.breed}"
								required>
						</div>
						<!--<div class="col">
							<label for="age" class="form-label">Age</label>
							<input type="number" class="form-control" id="age" name="age" th:value="${pet.age}"
								required>
						</div>-->
					</div>
					<div class="row mb-2">
						<div class="col"> <label for="color" class="form-label">Color</label> <input type="text"
								class="form-control" id="color" name="color" th:value="${pet.color}" required> </div>
						<div class="col"> <label for="description" class="form-label">Description</label> <input
								type="text" class="form-control" id="description" name="description"
								th:value="${pet.description}" required> </div>
					</div>
					<div class="mb-2"> <label for="imagePet" class="form-label">Upload New Image</label> <input
							type="file" class="form-control" id="imagePet" name="imagePet" accept="image/*"
							onchange="previewImage(event)"> <!-- แสดงภาพเดิม --> <img id="preview"
							th:src="@{'/img/pet_img/' + ${pet.imagePet}}" alt="Current Pet Image" class="mt-2"
							style="width: 150px; height: 150px; object-fit: cover;"> </div> <button type="submit"
						class="btn btn-primary">Update Pet</button> <a th:href="@{/admin/pet}"
						class="btn btn-secondary ms-2">Cancel</a> <!-- ✅ success / error message -->
					<div th:if="${session.succMsg}" class="alert alert-success mt-2" th:text="${session.succMsg}">
					</div>
					<div th:if="${session.errorMsg}" class="alert alert-danger mt-2" th:text="${session.errorMsg}">
					</div>
				</form>


			</div>
		</div>

		<!-- JavaScript to preview the selected image before upload -->
		<script>
			function previewImage(event) {
				const input = event.target;
				const preview = document.getElementById('preview');
				if (input.files && input.files[0]) {
					const reader = new FileReader();
					reader.onload = function (e) {
						preview.src = e.target.result; // เปลี่ยน src ของภาพให้เป็นภาพใหม่
					};
					reader.readAsDataURL(input.files[0]);
				}
			} 
		</script>

		<!-- JavaScript for autocomplete functionality -->
		<script th:inline="javascript">
			// ✅ สร้าง array ของเจ้าของสัตว์เลี้ยง (email + id)
			var owners = /*[[${owners}]]*/[];
			// console.log(owners);

			// ดึงเฉพาะ email ไปใช้กับ autocomplete
			var ownerEmails = owners.map(o => o.email);

			// ✅ autocomplete function
			function autocomplete(inp, arr) {
				var currentFocus;
				inp.addEventListener("input", function () {
					var a, b, i, val = this.value;
					closeAllLists();
					if (!val) return false;
					currentFocus = -1;

					a = document.createElement("DIV");
					a.setAttribute("id", this.id + "autocomplete-list");
					a.setAttribute("class", "autocomplete-items");
					this.parentNode.appendChild(a);

					for (i = 0; i < arr.length; i++) {
						if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
							b = document.createElement("DIV");
							b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
							b.innerHTML += arr[i].substr(val.length);
							b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";

							b.addEventListener("click", function () {
								inp.value = this.getElementsByTagName("input")[0].value;

								// ✅ หา owner.id จาก email ที่เลือก
								let owner = owners.find(o => o.email === inp.value);
								if (owner) {
									document.getElementById("ownerId").value = owner.id;
								} else {
									document.getElementById("ownerId").value = "";
								}

								closeAllLists();
							});

							a.appendChild(b);
						}
					}
				});

				inp.addEventListener("keydown", function (e) {
					var x = document.getElementById(this.id + "autocomplete-list");
					if (x) x = x.getElementsByTagName("div");
					if (e.keyCode == 40) {
						currentFocus++;
						addActive(x);
					} else if (e.keyCode == 38) {
						currentFocus--;
						addActive(x);
					} else if (e.keyCode == 13) {
						e.preventDefault();
						if (currentFocus > -1) {
							if (x) x[currentFocus].click();
						}
					}
				});

				function addActive(x) {
					if (!x) return false;
					removeActive(x);
					if (currentFocus >= x.length) currentFocus = 0;
					if (currentFocus < 0) currentFocus = x.length - 1;
					x[currentFocus].classList.add("autocomplete-active");
				}
				function removeActive(x) {
					for (var i = 0; i < x.length; i++) {
						x[i].classList.remove("autocomplete-active");
					}
				}
				function closeAllLists(elmnt) {
					var x = document.getElementsByClassName("autocomplete-items");
					for (var i = 0; i < x.length; i++) {
						if (elmnt != x[i] && elmnt != inp) {
							x[i].parentNode.removeChild(x[i]);
						}
					}
				}

				// ปิด autocomplete list ถ้าคลิกนอก
				document.addEventListener("click", function (e) {
					closeAllLists(e.target);
				});
			}

			// ✅ เรียกใช้ autocomplete
			autocomplete(document.getElementById("ownerEmail"), ownerEmails);
		</script>

		<style>
			.autocomplete-items {
				border: 1px solid #ddd;
				border-top: none;
				max-height: 200px;
				overflow-y: auto;
				background: white;
				position: absolute;
				z-index: 1000;
				width: 100%;
			}

			.autocomplete-items div {
				padding: 8px;
				cursor: pointer;
			}

			.autocomplete-items div:hover {
				background-color: #e9e9e9;
			}

			.autocomplete-active {
				background-color: #007bff !important;
				color: white;
			}
		</style>

	</section>
</body>

</html>